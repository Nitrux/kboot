#!/usr/bin/env bash

# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2023-2025 <Nitrux Latinoamericana S.C. <hello@nxos.org>>


# -- Exit on errors.
# -- Exit if undefined variables.

set -eu


# -- Set program name and version.

TOOL_NAME="Kernel Boot"
TOOL_SHRT_NAME="kboot"
TOOL_VERSION="1.0.0" 
VENDOR='Nitrux Latinoamericana S.C.'
FECHA=$(date +%Y)


# -- Print messages to stderr.

_puts() {
    [ -n "${1-}" ] || return 0

    level=$1
    shift || true

    [ $# -gt 0 ] || return 0

    case "$level" in
        info)    color='34'; label='Info' ;;
        success) color='32'; label='Success' ;;
        warning) color='33'; label='Warning' ;;
        error)   color='31'; label='Error' ;;
        *)       color='0';  label="$level" ;;
    esac

    if [ "$level" = "error" ]; then
        printf '%s: \033[%sm%s:\033[0m %b\n' "${TOOL_NAME-}" "$color" "$label" "$*" >&2
    else
        printf '%s: \033[%sm%s:\033[0m %s\n' "${TOOL_NAME-}" "$color" "$label" "$*" >&2
    fi
}

puts_info()    { _puts info "$@"; }
puts_success() { _puts success "$@"; }
puts_warning() { _puts warning "$@"; }
puts_error()   { _puts error "$@"; }

print_message() {
    if [ $# -eq 0 ]; then
        printf '\n' >&2
    else
        printf '%s\n' "$@" >&2
    fi
}


# -- Check if this is running as root.

if [ "$(id -u)" -ne 0 ]; then
    puts_error "$TOOL_NAME is not running as root, quitting."
    exit 1
else
    puts_success "$TOOL_NAME is running as root, continuing..."
    ROOT="sudo"
fi


# -- Check if any arguments are passed.

if [ "$#" -eq 0 ]; then
    puts_error "No arguments provided to $TOOL_NAME. Use -h for help."
    exit 1
fi


# -- Display an error when no flag is used.

error () {
  puts_error "$TOOL_SHRT_NAME: \e[31mError:\e[0m: $*" >&2
  exit 1
}


# -- Define the path of the kboot kernel files.

CONFIG_DIR="/etc/kboot.d"


# -- Check existence of kboot kernel files directory.

if [ -d "$CONFIG_DIR" ]; then
    puts_success "Kernel Boot directory found, continuing..."
else
    puts_error "Kernel Boot directory '$CONFIG_DIR' not found!, quitting."
    exit 1
fi


# -- Functions.

root_kexec() {
    local ROOT=("sudo" "kexec" "$@")

    if ! command -v "${ROOT[0]}" >/dev/null 2>&1; then
        puts_error "Error: '${ROOT[0]}' command not found. Please make sure it's installed and try again."
        return 1
    fi

    "${ROOT[@]}"
}

get_gpu_manufacturer() {
    nvidia-smi -L 2>/dev/null | awk -F ' ' '$3=="NVIDIA"{print $3; exit}' || true
}

load_config() {
    local config_file="$1"
    
    KEXEC_VMLINUZ=""
    KEXEC_INITRD=""
    KERNEL_PARAMETERS=""

    while IFS='=' read -r key value || [ -n "$key" ]; do
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)

        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue

        value="${value%\"}"
        value="${value#\"}"
        value="${value%\'}"
        value="${value#\'}"

        case "$key" in
            KEXEC_VMLINUZ)      KEXEC_VMLINUZ="$value" ;;
            KEXEC_INITRD)       KEXEC_INITRD="$value" ;;
            KERNEL_PARAMETERS)  KERNEL_PARAMETERS="$value" ;;
        esac
    done < "$config_file"
}


# -- Use a log file.

KBOOT_LOG="/var/log/kboot.log"

if [ -f "$KBOOT_LOG" ]; then
    puts_info "$TOOL_NAME log file found, skipping..."
else
    puts_info "Unable to locate $TOOL_NAME log file. Creating a new log file, continuing..."
    touch "$KBOOT_LOG"
    chmod 600 "$KBOOT_LOG"
fi

#   ====== START ======

# -- Flag parsing.
for cmd; do
    case "$cmd" in
        -h | --help)
            print_message "$TOOL_NAME" \
                "" \
                "Description:" \
                "" \
                "    $TOOL_NAME or $TOOL_SHRT_NAME is a utility for Nitrux OS that makes it easier to boot additional Linux kernels." \
                "    ⚠️ Important: $TOOL_SHRT_NAME is intended to work exclusively in Nitrux OS, and using this utility in other distributions is not supported at all." \
                "" \
                "    Report bugs at: https://github.com/Nitrux/kboot/issues." \
                "" \
                "Flags:" \
                "    -h or --help        Show this help." \
                "    -v or --version     Show the version." \
                "    -d or --debug       Enable verbose output." \
                "" \
                "Operations:" \
                "    switch              Switches the kernel using the settings in the specified configuration file, e.g debian or liquorix." \
                "" \
                "Usage:" \
                "    sudo kboot <flag> (operation)" \
                "" \
                "Examples:" \
                "    sudo kboot switch debian" \
                "    sudo kboot -d switch liquorix"

            exit
            ;;

        -v | --version)
            print_message "$TOOL_NAME" \
                "" \
                "Version: $TOOL_VERSION." \
                "" \
                "The license used for this file and its contents is: BSD-3-Clause." \
                "" \
                "Authors:" \
                "" \
                "    Copyright <2023-2025> <Uri Herrera <uri_herrera@nxos.org>>" \
                "" \
                "(c) $FECHA Some Rights Reserved. Made by $VENDOR"

            exit
            ;;

        -d | --debug)
            set -x
            shift
            ;;
    esac
done

if [ "$(get_gpu_manufacturer)" == "NVIDIA" ]; then
    puts_warning "Kernel Boot is not a viable option for users of NVIDIA GPUs due to how the NVIDIA proprietary driver works with the Linux kernel."
    puts_warning "To use a different kernel, see https://nxos.org/tutorial/how-to-use-kernel-boot/#using-kernels-from-distrobox-containers. Bye."
    exit 0
fi

( for cmd; do
    case "${1,,}" in
    '' )  error "No operation specified (use -h to see a list of operations).";;
    switch)
        if [ -z "${2:-}" ]; then
            puts_error "Missing configuration file argument for 'switch' operation."
            exit 1
        fi

        FILE_NAME="$2"
        FILE_PATH="$CONFIG_DIR/$FILE_NAME"

        if [ ! -f "$FILE_PATH" ]; then
            puts_error "Configuration file '$FILE_NAME' not found in '$CONFIG_DIR' directory!, quitting."
            exit 1
        fi

        load_config "$FILE_PATH"

        if [ -z "${KEXEC_VMLINUZ:-}" ]; then
            puts_error "Invalid config: KEXEC_VMLINUZ is missing in '$FILE_NAME'."
            exit 1
        fi

        if [ -z "${KEXEC_INITRD:-}" ]; then
            puts_error "Invalid config: KEXEC_INITRD is missing in '$FILE_NAME'."
            exit 1
        fi

        puts_info "Loading kernel: $KEXEC_VMLINUZ"
        puts_info "With initrd: $KEXEC_INITRD"
        
        root_kexec -l "$KEXEC_VMLINUZ" --initrd="$KEXEC_INITRD" --append="$KERNEL_PARAMETERS" || exit 1
        
        puts_success "Kernel loaded successfully. Switching now..."
        root_kexec -e
        ;;
    *)
        puts_error "Invalid flag!. Use 'kboot switch <file_name>' to load a new kernel image, quitting."
        exit 1
        ;;
    esac
done ) 2>&1 | tee -a "$KBOOT_LOG"

#   ====== END ======
